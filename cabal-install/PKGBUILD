# Maintainer: Magnus Therning <magnus@therning.org>

_stackver=v1.6.5
_stackname=stack-1.6.5-linux-x86_64-static
pkgname=cabal-install
pkgver=2.2.0.0
pkgrel=0.1
pkgdesc="The command-line interface for Cabal and Hackage."
arch=('x86_64')
url='http://www.haskell.org/cabal/'
license=('BSD3')
makedepends=('ncurses5-compat-libs')
options=('strip' 'staticlibs')
source=("http://hackage.haskell.org/packages/archive/${pkgname}/${pkgver}/${pkgname}-${pkgver}.tar.gz"
        "https://github.com/commercialhaskell/stack/releases/download/${_stackver}/${_stackname}.tar.gz"
        "stack.yaml"
       )
sha256sums=('c856a2dd93c5a7b909597c066b9f9ca27fbda1a502b3f96077b7918c0f64a3d9'
            'f8876fa73c4bb95c1d762073af2dfa4a003d795709ec3fee2f9743ca6a5fedc6'
            'f9eaf9ae39f51245c91c32c4f00aece317691394fec80b1ae0f4abe8d8370a0d')

prepare() {
  export PATH="${srcdir}/${_stackname}:${PATH}"
  cd "${srcdir}/${pkgname}-${pkgver}"

  cp ${srcdir}/stack.yaml .
  stack update
  stack setup
}

build() {
  export PATH="${srcdir}/${_stackname}:${PATH}"
  cd "${srcdir}/${pkgname}-${pkgver}"

  stack build
  stack \
        exec ghc-pkg -- list | grep pkgdb | awk '{print "--package-db=" $0}' > db-paths
  stack \
        exec --no-ghc-package-path cabal -- configure \
        $(cat db-paths) \
        --prefix=/usr --docdir="/usr/share/doc/${pkgname}"
  stack \
        exec --no-ghc-package-path cabal -- build
}

check() {
  true
}

package() {
  export PATH="${srcdir}/${_stackname}:${PATH}"
  cd "${srcdir}/${pkgname}-${pkgver}"

  stack \
        exec --no-ghc-package-path cabal -- copy \
        --destdir="${pkgdir}"

  chmod a+r "${pkgdir}/usr/share/man/man1/cabal.1"
}
