# Maintainer: Magnus Therning <magnus@therning.org>

pkgname=shelltestrunner
pkgver=1.9
pkgrel=100
pkgdesc="Source code suggestions"
arch=('x86_64')
url='http://www.haskell.org/cabal/'
license=('BSD3')
makedepends=('cabal-install' 'stack')
depends=()
options=('strip' 'staticlibs')
source=("http://hackage.haskell.org/packages/archive/${pkgname}/${pkgver}/${pkgname}-${pkgver}.tar.gz"
        "stack.yaml"
       )
sha256sums=('cbc4358d447e32babe4572cda0d530c648cc4c67805f9f88002999c717feb3a8'
            'd263f69bc25d58701330ba8e4c74c21e829c371178e39ce20a6d84cb25055670')

prepare() {
  cd "${srcdir}/${pkgname}-${pkgver}"

  cp "${srcdir}/stack.yaml" .
  stack update
  stack setup
}

build() {
  cd "${srcdir}/${pkgname}-${pkgver}"

  stack build --dependencies-only
  stack \
        exec ghc-pkg -- list | awk 'BEGIN { FS="[ :]" } /pkgdb/ {print "--package-db=" $1}' > db-paths
  stack \
        exec --no-ghc-package-path cabal -- configure \
        $(cat db-paths) \
        --prefix=/usr --docdir="/usr/share/doc/${pkgname}"
  stack \
        exec --no-ghc-package-path cabal -- build
}

check() {
  true
}

package() {
  cd "${srcdir}/${pkgname}-${pkgver}"

  stack \
        exec --no-ghc-package-path cabal -- copy \
        --destdir="${pkgdir}"

  #rm -fr "${pkgdir}/usr/lib"
}
